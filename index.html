<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∫∫‰ΩìÁóõ„Åø„Éû„ÉÉ„Éó v0.30</title>
    <style>
        /* „Éá„Éê„Ç§„ÇπÊÉÖÂ†±Ë°®Á§∫ */
        .device-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 10px;
            z-index: 1000;
            display: none;
        }
        
        .device-info.show {
            display: block;
        }
        
        /* ÁîªÈù¢„Çµ„Ç§„Ç∫Ë°®Á§∫ */
        .screen-size {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            position: relative;
        }
        
        .version-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: normal;
        }

        .view-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab-button {
            padding: 12px 30px;
            background: #f0f0f0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
        }

        .main-content {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }
        
        /* „É¢„Éê„Ç§„É´ÂØæÂøú */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
                border-radius: 10px;
            }
            
            h1 {
                font-size: 1.5em;
                margin-bottom: 15px;
            }
            
            .version-badge {
                font-size: 10px;
                padding: 3px 8px;
            }
            
            .main-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .body-view {
                width: 100%;
                min-height: 400px;
            }
            
            .body-canvas {
                height: 400px;
            }
            
            .controls {
                width: 100%;
            }
            
            .view-tabs {
                gap: 5px;
                margin-bottom: 15px;
            }
            
            .tab-button {
                padding: 8px 15px;
                font-size: 12px;
            }
            
            .pain-btn {
                padding: 10px;
                font-size: 14px;
            }
            
            .mode-toggle {
                flex-direction: column;
            }
            
            .mode-btn {
                width: 100%;
            }
            
            p {
                font-size: 10px !important;
            }
        }
        
        /* Â∞èÂûã„É¢„Éê„Ç§„É´ÂØæÂøúÔºàiPhone SE„Å™„Å©Ôºâ */
        @media (max-width: 375px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.2em;
            }
            
            .body-canvas {
                height: 350px;
            }
            
            .tab-button {
                padding: 6px 10px;
                font-size: 11px;
            }
        }

        .body-view {
            flex: 1;
            background: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
            min-height: 600px;
            position: relative;
        }

        .body-canvas {
            width: 100%;
            height: 600px;
            border-radius: 10px;
            background: white;
            cursor: crosshair;
        }

        .controls {
            width: 350px;
            background: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group label {
            display: block;
            margin-bottom: 10px;
            color: #555;
            font-weight: 600;
        }

        .pain-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .pain-btn {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pain-btn:hover {
            transform: scale(1.05);
            border-color: #667eea;
        }

        .pain-btn.selected {
            border-color: #667eea;
            border-width: 3px;
        }

        .pain-btn[data-level="0"] {
            background: #f0f0f0;
            color: #666;
        }

        .pain-btn[data-level="1"],
        .pain-btn[data-level="2"] {
            background: #ffeeee;
            color: #cc0000;
        }

        .pain-btn[data-level="3"],
        .pain-btn[data-level="4"],
        .pain-btn[data-level="5"] {
            background: #ffcccc;
            color: #990000;
        }

        .pain-btn[data-level="6"],
        .pain-btn[data-level="7"] {
            background: #ff9999;
            color: #660000;
        }

        .pain-btn[data-level="8"],
        .pain-btn[data-level="9"],
        .pain-btn[data-level="10"] {
            background: #ff6666;
            color: white;
        }

        .pain-value {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-top: 10px;
            color: #333;
        }

        .body-part-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .mode-btn:hover {
            border-color: #667eea;
            transform: scale(1.02);
        }

        .legend {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .body-svg {
            width: 100%;
            height: 100%;
        }

        .body-part {
            fill: #f0f0f0;
            stroke: #333;
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.3s;
        }

        .head-cell {
            fill: #f0f0f0;
            stroke: #aaa;
            stroke-width: 0.5;
            cursor: pointer;
            transition: all 0.3s;
        }

        .head-cell:hover {
            stroke: #667eea;
            stroke-width: 1.5;
            filter: brightness(0.95);
        }

        .head-cell.selected {
            stroke: #667eea;
            stroke-width: 2;
        }

        .body-part:hover {
            stroke-width: 3;
            filter: brightness(0.95);
        }

        .body-part.selected {
            stroke: #667eea;
            stroke-width: 4;
        }

        #savedMaps {
            margin-top: 20px;
        }

        .saved-map-item {
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .saved-map-item:hover {
            background: #f0f0f0;
            transform: translateX(5px);
        }

        .date-time {
            font-size: 12px;
            color: #888;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            font-size: 16px;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .selection-box {
            position: absolute;
            border: 2px solid #4A90E2;
            background: rgba(74, 144, 226, 0.2);
            pointer-events: none;
            display: none;
            z-index: 100;
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.3);
        }
    </style>
</head>
<body>
    <div id="notification" class="notification"></div>
    <div class="device-info" id="deviceInfo"></div>
    <div class="screen-size" id="screenSize"></div>
    <div class="container">
        <h1>
            üè• ‰∫∫‰ΩìÁóõ„Åø„Éû„ÉÉ„Éó
            <span class="version-badge">v0.30</span>
        </h1>
        <p style="text-align: center; color: #666; margin-top: -20px; margin-bottom: 20px;">
            üñ±Ô∏è „Éâ„É©„ÉÉ„Ç∞„ÅßÁü©ÂΩ¢ÈÅ∏Êäû | „ÇØ„É™„ÉÉ„ÇØ„ÅßÈÅ∏Êäû/Ëß£Èô§ | Ctrl+„ÇØ„É™„ÉÉ„ÇØ„ÅßËøΩÂä† | Á©∫ÁôΩ„ÇØ„É™„ÉÉ„ÇØ„ÅßÂÖ®Ëß£Èô§
        </p>
        
        <div class="view-tabs">
            <button class="tab-button active" data-view="front">ÂâçÈù¢</button>
            <button class="tab-button" data-view="back">ËÉåÈù¢</button>
            <button class="tab-button" data-view="left">Â∑¶ÂÅ¥Èù¢</button>
            <button class="tab-button" data-view="right">Âè≥ÂÅ¥Èù¢</button>
        </div>

        <div class="main-content">
            <div class="body-view">
                <svg class="body-svg" viewBox="0 0 400 600" id="bodySvg">
                    <!-- Front View -->
                    <g id="front-view">
                        <!-- All body parts will be generated as grids by JavaScript -->
                        <!-- Head outline -->
                        <ellipse fill="none" stroke="#999" stroke-width="1" cx="200" cy="80" rx="50" ry="60"/>
                        <!-- Body outlines hidden - grids will show the shape -->
                    </g>

                    <!-- Back View (hidden by default) -->
                    <g id="back-view" style="display: none;">
                        <!-- Grids will be generated by JavaScript -->
                    </g>

                    <!-- Left Side View -->
                    <g id="left-view" style="display: none;">
                        <!-- Grids will be generated by JavaScript -->
                    </g>

                    <!-- Right Side View -->
                    <g id="right-view" style="display: none;">
                        <!-- Grids will be generated by JavaScript -->
                    </g>
                </svg>
                <div id="selectionBox" class="selection-box"></div>
            </div>

            <div class="controls">
                <div class="mode-toggle">
                    <button id="singleModeBtn" class="mode-btn active">üîÜ Âçò‰∏ÄÈÅ∏Êäû</button>
                    <button id="multiModeBtn" class="mode-btn">‚úÖ Ë§áÊï∞ÈÅ∏Êäû</button>
                    <button id="clearSelectionBtn" class="mode-btn" style="background: #ff6b6b; color: white;">üóëÔ∏è ÈÅ∏ÊäûËß£Èô§</button>
                </div>

                <div class="control-group">
                    <label for="personSelect">‰∫∫Áâ©„ÇíÈÅ∏Êäû:</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="personSelect" class="body-part-select" style="flex: 1;">
                            <option value="">‰∫∫Áâ©„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        </select>
                        <button class="btn btn-secondary" id="addPersonBtn" style="width: auto; padding: 10px 15px;">Êñ∞Ë¶èËøΩÂä†</button>
                    </div>
                </div>

                <div class="control-group">
                    <label for="dateSelect">Ë®òÈå≤Êó•‰ªò:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="date" id="dateInput" class="body-part-select" style="flex: 1;">
                        <button class="btn btn-secondary" id="todayBtn" style="width: auto; padding: 10px 15px;">‰ªäÊó•</button>
                    </div>
                    <div style="margin-top: 10px;">
                        <select id="dateHistorySelect" class="body-part-select">
                            <option value="">ÈÅéÂéª„ÅÆË®òÈå≤„Åã„ÇâÈÅ∏Êäû...</option>
                        </select>
                    </div>
                </div>

                <div class="control-group">
                    <label for="bodyPartSelect">ÈÉ®‰Ωç„ÇíÈÅ∏Êäû:</label>
                    <select id="bodyPartSelect" class="body-part-select">
                        <option value="">„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÉ®‰Ωç„ÇíÈÅ∏Êäû</option>
                        <option value="head">È†≠ÈÉ®</option>
                        <option value="neck">È¶ñ</option>
                        <option value="left-shoulder">Â∑¶ËÇ©</option>
                        <option value="right-shoulder">Âè≥ËÇ©</option>
                        <option value="chest">ËÉ∏ÈÉ®</option>
                        <option value="abdomen">ËÖπÈÉ®</option>
                        <option value="lower-back">ËÖ∞</option>
                        <option value="left-upper-arm">Â∑¶‰∏äËÖï</option>
                        <option value="right-upper-arm">Âè≥‰∏äËÖï</option>
                        <option value="left-lower-arm">Â∑¶ÂâçËÖï</option>
                        <option value="right-lower-arm">Âè≥ÂâçËÖï</option>
                        <option value="left-thigh">Â∑¶Â§™„ÇÇ„ÇÇ</option>
                        <option value="right-thigh">Âè≥Â§™„ÇÇ„ÇÇ</option>
                        <option value="left-shin">Â∑¶„Åô„Å≠</option>
                        <option value="right-shin">Âè≥„Åô„Å≠</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Áóõ„Åø„É¨„Éô„É´„ÇíÈÅ∏Êäû:</label>
                    <div class="pain-buttons">
                        <button class="pain-btn" data-level="1">1</button>
                        <button class="pain-btn" data-level="2">2</button>
                        <button class="pain-btn" data-level="3">3</button>
                        <button class="pain-btn" data-level="4">4</button>
                        <button class="pain-btn" data-level="5">5</button>
                        <button class="pain-btn" data-level="6">6</button>
                        <button class="pain-btn" data-level="7">7</button>
                        <button class="pain-btn" data-level="8">8</button>
                        <button class="pain-btn" data-level="9">9</button>
                        <button class="pain-btn" data-level="10">10</button>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <button class="pain-btn" data-level="0" style="width: 100%;">0 (Áóõ„Åø„Å™„Åó)</button>
                    </div>
                    <div class="pain-value" id="painValue" style="text-align: center; font-size: 24px; font-weight: bold; margin-top: 10px; color: #333;">ÈÅ∏Êäû: 0</div>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffcccc;"></div>
                        <span>Âº±„ÅÑ (0-3)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff6666;"></div>
                        <span>‰∏≠Á®ãÂ∫¶ (4-7)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #cc0000;"></div>
                        <span>Âº∑„ÅÑ (8-10)</span>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveBtn">‰øùÂ≠ò</button>
                    <button class="btn btn-secondary" id="clearBtn">„ÇØ„É™„Ç¢</button>
                    <button class="btn btn-secondary" id="deletePersonBtn">‰∫∫Áâ©ÂâäÈô§</button>
                </div>

                <div class="control-group">
                    <label>ÂÖ®‰ΩìË™øÊï¥ÔºàËâ≤„ÇíÂ°ó„Å£„ÅüÁÆáÊâÄ„ÅÆ„ÅøÔºâ:</label>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" id="decreaseAllBtn">-1 ‰∏ã„Åí„Çã</button>
                        <button class="btn btn-secondary" id="increaseAllBtn">+1 ‰∏ä„Åí„Çã</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>ÁôªÈå≤Ê∏à„Åø‰∫∫Áâ©:</label>
                    <div id="personList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Pain map data storage
        let painData = {};
        let currentView = 'front';
        let selectedParts = new Set();
        let currentPerson = null;
        let currentDate = null;
        let personsData = {};
        let isSelecting = false;
        let selectionStart = null;
        let multiSelectMode = false;

        // Show notification
        function showNotification(message, duration = 2000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadPersonsData();
            initializeEventListeners();
            createHeadGrid();
            initializeSampleData();
            updatePersonList();
            initializeDragSelection();
            initializeDateControls();
            detectDevice();
        });
        
        // „Éá„Éê„Ç§„ÇπÊ§úÂá∫„Å®Ë°®Á§∫
        function detectDevice() {
            const deviceInfo = document.getElementById('deviceInfo');
            const width = window.innerWidth;
            const height = window.innerHeight;
            const userAgent = navigator.userAgent;
            
            let deviceType = 'Desktop';
            let osType = 'Unknown';
            
            // OSÂà§ÂÆö
            if (/iPhone|iPad|iPod/.test(userAgent)) {
                osType = 'iOS';
                deviceType = 'Mobile';
            } else if (/Android/.test(userAgent)) {
                osType = 'Android';
                deviceType = 'Mobile';
            } else if (/Windows/.test(userAgent)) {
                osType = 'Windows';
            } else if (/Mac/.test(userAgent)) {
                osType = 'macOS';
            }
            
            // ÁîªÈù¢„Çµ„Ç§„Ç∫„Åß„ÇÇÂà§ÂÆö
            if (width <= 768) {
                deviceType = 'Mobile';
            } else if (width <= 1024) {
                deviceType = 'Tablet';
            }
            
            // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Ë°®Á§∫ÔºàÈñãÁô∫ÊôÇ„ÅÆ„ÅøÔºâ
            const debugMode = localStorage.getItem('debugMode') === 'true';
            if (debugMode) {
                deviceInfo.innerHTML = `
                    üì± ${deviceType} | ${osType}<br>
                    üìÄ ${width} x ${height}px<br>
                    üîç DPR: ${window.devicePixelRatio}
                `;
                deviceInfo.classList.add('show');
            }
            
            // „É¢„Éê„Ç§„É´Áî®„ÅÆË™øÊï¥
            if (deviceType === 'Mobile') {
                // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà„ÇíÊúÄÈÅ©Âåñ
                document.body.style.touchAction = 'pan-y';
                
                // SVG„ÅÆ„Çµ„Ç§„Ç∫Ë™øÊï¥
                const svgElement = document.getElementById('bodySvg');
                if (svgElement && width < 400) {
                    svgElement.setAttribute('viewBox', '0 0 400 600');
                    svgElement.style.maxWidth = '100%';
                }
            }
            
            console.log(`Device: ${deviceType}, OS: ${osType}, Screen: ${width}x${height}`);
        }
        
        // „Ç¶„Ç£„É≥„Éâ„Ç¶„Çµ„Ç§„Ç∫Â§âÊõ¥ÊôÇ„Å´ÂÜçÊ§úÂá∫
        window.addEventListener('resize', detectDevice);
        
        // „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÂàá„ÇäÊõø„ÅàÔºà„Ç≥„É≥„ÇΩ„Éº„É´„Åß toggleDebug() „ÇíÂÆüË°åÔºâ
        window.toggleDebug = function() {
            const current = localStorage.getItem('debugMode') === 'true';
            localStorage.setItem('debugMode', !current);
            detectDevice();
            return `Debug mode: ${!current}`;
        };

        // Initialize drag selection
        function initializeDragSelection() {
            const svgElement = document.getElementById('bodySvg');
            const selectionBox = document.getElementById('selectionBox');
            let startX, startY;
            let dragStartedOnPart = false;
            let touchStartTime = 0;

            // Mode toggle buttons
            document.getElementById('singleModeBtn').addEventListener('click', function() {
                multiSelectMode = false;
                this.classList.add('active');
                document.getElementById('multiModeBtn').classList.remove('active');
                showNotification('Âçò‰∏ÄÈÅ∏Êäû„É¢„Éº„Éâ');
            });

            document.getElementById('multiModeBtn').addEventListener('click', function() {
                multiSelectMode = true;
                this.classList.add('active');
                document.getElementById('singleModeBtn').classList.remove('active');
                showNotification('Ë§áÊï∞ÈÅ∏Êäû„É¢„Éº„Éâ');
            });
            
            // Clear selection button for mobile
            document.getElementById('clearSelectionBtn').addEventListener('click', function() {
                selectedParts.clear();
                document.querySelectorAll('.head-cell.selected, .body-part.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                updatePainButtonSelection(0);
                document.getElementById('bodyPartSelect').value = '';
                showNotification('ÈÅ∏Êäû„ÇíËß£Èô§„Åó„Åæ„Åó„Åü');
            });

            // Mouse events for drag selection  
            const bodyView = document.querySelector('.body-view');
            
            bodyView.addEventListener('mousedown', function(e) {
                // Check if clicking on a part
                if (e.target.classList.contains('head-cell') || e.target.classList.contains('body-part')) {
                    dragStartedOnPart = true;
                    // Handle single click on part - now it works as toggle
                    return;
                }
                
                // Check if clicking on SVG background
                if (!e.target.closest('#bodySvg')) {
                    return;
                }
                
                // Clicking on empty SVG space - clear selection unless Ctrl is held
                if (!e.ctrlKey && !e.metaKey) {
                    // Clear all selections
                    selectedParts.clear();
                    document.querySelectorAll('.head-cell.selected, .body-part.selected').forEach(el => {
                        el.classList.remove('selected');
                    });
                    updatePainButtonSelection(0);
                    document.getElementById('bodyPartSelect').value = '';
                }
                
                dragStartedOnPart = false;
                e.preventDefault();
                
                isSelecting = true;
                const rect = bodyView.getBoundingClientRect();
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;
                selectionStart = { x: startX, y: startY };
                
                selectionBox.style.left = startX + 'px';
                selectionBox.style.top = startY + 'px';
                selectionBox.style.width = '0px';
                selectionBox.style.height = '0px';
                selectionBox.style.display = 'block';
            });

            document.addEventListener('mousemove', function(e) {
                if (!isSelecting) return;
                
                const rect = bodyView.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;
                
                const width = Math.abs(currentX - startX);
                const height = Math.abs(currentY - startY);
                const left = Math.min(currentX, startX);
                const top = Math.min(currentY, startY);
                
                selectionBox.style.left = left + 'px';
                selectionBox.style.top = top + 'px';
                selectionBox.style.width = width + 'px';
                selectionBox.style.height = height + 'px';
                
                // „É™„Ç¢„É´„Çø„Ç§„É†„ÅßÈÅ∏ÊäûÁä∂ÊÖã„ÇíË°®Á§∫
                const boxRect = {
                    left: rect.left + left,
                    top: rect.top + top,
                    right: rect.left + left + width,
                    bottom: rect.top + top + height
                };
                
                document.querySelectorAll('.head-cell, .body-part').forEach(part => {
                    const partRect = part.getBoundingClientRect();
                    const partCenterX = partRect.left + partRect.width / 2;
                    const partCenterY = partRect.top + partRect.height / 2;
                    
                    // Áü©ÂΩ¢ÈÅ∏ÊäûÁØÑÂõ≤ÂÜÖ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    const inSelection = partCenterX >= boxRect.left && partCenterX <= boxRect.right &&
                                       partCenterY >= boxRect.top && partCenterY <= boxRect.bottom;
                    
                    if (inSelection) {
                        part.style.opacity = '0.7';
                        part.style.filter = 'brightness(1.2)';
                    } else if (!selectedParts.has(part.dataset.part)) {
                        part.style.opacity = '1';
                        part.style.filter = 'none';
                    }
                });
            });

            document.addEventListener('mouseup', function(e) {
                if (!isSelecting) return;
                
                isSelecting = false;
                
                // Get final selection box coordinates
                const rect = bodyView.getBoundingClientRect();
                const endX = e.clientX - rect.left;
                const endY = e.clientY - rect.top;
                
                const left = Math.min(startX, endX);
                const top = Math.min(startY, endY);
                const right = Math.max(startX, endX);
                const bottom = Math.max(startY, endY);
                const width = right - left;
                const height = bottom - top;
                
                selectionBox.style.display = 'none';
                
                // Reset visual effects
                document.querySelectorAll('.head-cell, .body-part').forEach(part => {
                    part.style.opacity = '1';
                    part.style.filter = 'none';
                });
                
                // Only proceed if the box has some size (not just a click)
                if (width > 5 && height > 5) {
                    let selectedCount = 0;
                    const bodyViewRect = bodyView.getBoundingClientRect();
                    
                    // Calculate actual selection box coordinates relative to viewport
                    const selectionLeft = bodyViewRect.left + left;
                    const selectionTop = bodyViewRect.top + top;
                    const selectionRight = bodyViewRect.left + right;
                    const selectionBottom = bodyViewRect.top + bottom;
                    
                    
                    document.querySelectorAll('.body-part, .head-cell').forEach(part => {
                        const partRect = part.getBoundingClientRect();
                        const partCenterX = partRect.left + partRect.width / 2;
                        const partCenterY = partRect.top + partRect.height / 2;
                        
                        // Check if part center is within selection box
                        if (partCenterX >= selectionLeft && partCenterX <= selectionRight &&
                            partCenterY >= selectionTop && partCenterY <= selectionBottom) {
                            // Add to selection (don't toggle in drag selection)
                            selectedParts.add(part.dataset.part);
                            part.classList.add('selected');
                            selectedCount++;
                        }
                    });
                    
                    if (selectedCount > 0) {
                        showNotification(`${selectedCount}ÂÄã„ÅÆÈÉ®‰Ωç„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü`);
                        
                        // Update pain level UI
                        if (selectedParts.size > 0) {
                            let totalPain = 0;
                            selectedParts.forEach(partName => {
                                totalPain += painData[partName] || 0;
                            });
                            const avgPain = totalPain / selectedParts.size;
                            updatePainButtonSelection(Math.round(avgPain));
                        }
                    }
                }
            });

            // Cancel selection on escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (isSelecting) {
                        isSelecting = false;
                        selectionBox.style.display = 'none';
                        
                        // Reset visual effects
                        document.querySelectorAll('.head-cell, .body-part').forEach(part => {
                            part.style.opacity = '1';
                            part.style.filter = 'none';
                        });
                    } else {
                        // Clear all selections
                        selectedParts.clear();
                        document.querySelectorAll('.head-cell.selected, .body-part.selected').forEach(el => {
                            el.classList.remove('selected');
                        });
                        showNotification('ÈÅ∏Êäû„ÇíËß£Èô§„Åó„Åæ„Åó„Åü');
                    }
                }
            });
        }

        // Initialize sample data
        function initializeSampleData() {
            const saved = localStorage.getItem('personsData');
            if (!saved) {
                // „Çµ„É≥„Éó„É´„Éá„Éº„Çø„Çí‰ΩúÊàêÔºàÊó•‰ªò„Éô„Éº„Çπ„ÅÆÊßãÈÄ†Ôºâ
                personsData = {
                    'A„Åï„Çì': {
                        dates: {}
                    },
                    'B„Åï„Çì': {
                        dates: {}
                    },
                    'C„Åï„Çì': {
                        dates: {}
                    }
                };
                savePersonsData();
            } else {
                // ÊóßÂΩ¢Âºè„Åã„ÇâÊñ∞ÂΩ¢Âºè„Å∏„ÅÆÁßªË°å
                const data = JSON.parse(saved);
                let needsUpdate = false;
                Object.keys(data).forEach(person => {
                    if (!data[person].dates) {
                        const oldData = data[person];
                        data[person] = {
                            dates: Object.keys(oldData).length > 0 ? { [new Date().toISOString().split('T')[0]]: oldData } : {}
                        };
                        needsUpdate = true;
                    }
                });
                if (needsUpdate) {
                    personsData = data;
                    savePersonsData();
                }
            }
        }

        // Load persons data from localStorage
        function loadPersonsData() {
            const saved = localStorage.getItem('personsData');
            if (saved) {
                personsData = JSON.parse(saved);
            }
            updatePersonSelect();
        }

        // Save persons data to localStorage
        function savePersonsData() {
            localStorage.setItem('personsData', JSON.stringify(personsData));
            updatePersonSelect();
            updatePersonList();
        }

        // Update person select dropdown
        function updatePersonSelect() {
            const select = document.getElementById('personSelect');
            select.innerHTML = '<option value="">‰∫∫Áâ©„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
            Object.keys(personsData).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                if (name === currentPerson) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // Update person list display
        function updatePersonList() {
            const container = document.getElementById('personList');
            container.innerHTML = '';
            Object.keys(personsData).forEach(name => {
                const item = document.createElement('div');
                item.className = 'saved-map-item';
                const dateCount = Object.keys(personsData[name]?.dates || {}).length;
                const lastDate = Object.keys(personsData[name]?.dates || {}).sort().pop() || 'Ë®òÈå≤„Å™„Åó';
                item.innerHTML = `
                    <div style="font-weight: bold;">${name}</div>
                    <div class="date-time">Ë®òÈå≤Êï∞: ${dateCount}Êó•ÂàÜ</div>
                    <div class="date-time">ÊúÄÁµÇË®òÈå≤: ${lastDate}</div>
                `;
                item.addEventListener('click', () => {
                    document.getElementById('personSelect').value = name;
                    loadPerson(name);
                });
                container.appendChild(item);
            });
        }

        // Load person data
        function loadPerson(name) {
            if (personsData[name]) {
                currentPerson = name;
                updateDateHistory();
                
                // ÊúÄÊñ∞„ÅÆÊó•‰ªò„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÇÄÔºàÊó•‰ªò„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ‰ªäÊó•Ôºâ
                const dates = Object.keys(personsData[name].dates || {}).sort();
                const latestDate = dates.length > 0 ? dates[dates.length - 1] : new Date().toISOString().split('T')[0];
                document.getElementById('dateInput').value = latestDate;
                currentDate = latestDate;
                
                loadDateData(latestDate);
                showNotification(`${name}„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);
            }
        }

        // Load data for specific date
        function loadDateData(date) {
            if (currentPerson && personsData[currentPerson] && personsData[currentPerson].dates[date]) {
                painData = {...personsData[currentPerson].dates[date]};
            } else {
                painData = {};
            }
            
            // Update all body parts
            document.querySelectorAll('.body-part, .head-cell').forEach(part => {
                const partName = part.dataset.part;
                const painLevel = painData[partName] || 0;
                updatePartColor(part, painLevel);
            });
            
            console.log(`Loaded data for ${currentPerson} on ${date}:`, painData);
        }

        // Update date history dropdown
        function updateDateHistory() {
            const select = document.getElementById('dateHistorySelect');
            select.innerHTML = '<option value="">ÈÅéÂéª„ÅÆË®òÈå≤„Åã„ÇâÈÅ∏Êäû...</option>';
            
            if (currentPerson && personsData[currentPerson]) {
                const dates = Object.keys(personsData[currentPerson].dates || {}).sort().reverse();
                dates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    const dataCount = Object.keys(personsData[currentPerson].dates[date] || {}).length;
                    option.textContent = `${date} (${dataCount}ÈÉ®‰Ωç)`;
                    select.appendChild(option);
                });
            }
        }

        // Person select change handler
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('personSelect').addEventListener('change', function() {
                if (this.value) {
                    loadPerson(this.value);
                }
            });

            // Add person button
            document.getElementById('addPersonBtn').addEventListener('click', function() {
                const name = prompt('Êñ∞„Åó„ÅÑ‰∫∫Áâ©„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
                if (name && name.trim()) {
                    if (personsData[name]) {
                        showNotification('„Åù„ÅÆÂêçÂâç„ÅØÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                    } else {
                        personsData[name] = { dates: {} };
                        currentPerson = name;
                        currentDate = new Date().toISOString().split('T')[0];
                        document.getElementById('dateInput').value = currentDate;
                        painData = {};
                        savePersonsData();
                        document.getElementById('personSelect').value = name;
                        updateDateHistory();
                        
                        // Clear all body parts
                        document.querySelectorAll('.body-part, .head-cell').forEach(part => {
                            part.style.fill = '#f0f0f0';
                        });
                        
                        showNotification(`${name}„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`);
                    }
                }
            });

            // Increase/Decrease all painted parts
            document.getElementById('increaseAllBtn').addEventListener('click', function() {
                Object.keys(painData).forEach(partName => {
                    if (painData[partName] > 0 && painData[partName] < 10) {
                        painData[partName] = Math.min(10, painData[partName] + 1);
                        const part = document.querySelector(`[data-part="${partName}"]`);
                        if (part) {
                            updatePartColor(part, painData[partName]);
                        }
                    }
                });
                showNotification('Ëâ≤„ÅåÂ°ó„Çâ„Çå„ÅüÈÉ®‰Ωç„Çí+1„Åó„Åæ„Åó„Åü');
            });

            document.getElementById('decreaseAllBtn').addEventListener('click', function() {
                Object.keys(painData).forEach(partName => {
                    if (painData[partName] > 1) {
                        painData[partName] = Math.max(0, painData[partName] - 1);
                        const part = document.querySelector(`[data-part="${partName}"]`);
                        if (part) {
                            updatePartColor(part, painData[partName]);
                        }
                    }
                });
                showNotification('Ëâ≤„ÅåÂ°ó„Çâ„Çå„ÅüÈÉ®‰Ωç„Çí-1„Åó„Åæ„Åó„Åü');
            });

            // Delete person button
            document.getElementById('deletePersonBtn').addEventListener('click', function() {
                if (!currentPerson) {
                    showNotification('ÂâäÈô§„Åô„Çã‰∫∫Áâ©„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                if (confirm(`${currentPerson}„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                    delete personsData[currentPerson];
                    savePersonsData();
                    currentPerson = null;
                    painData = {};
                    document.getElementById('personSelect').value = '';
                    
                    // Clear all body parts
                    document.querySelectorAll('.body-part, .head-cell').forEach(part => {
                        part.style.fill = '#f0f0f0';
                    });
                    
                    showNotification('ÂâäÈô§„Åó„Åæ„Åó„Åü');
                }
            });
        });

        // Create grids for all body parts
        function createHeadGrid() {
            createBodyGrids();
        }

        function createBodyGrids() {
            // Create grids for all views
            createViewGrids('front-view', getFrontBodyParts());
            createViewGrids('back-view', getBackBodyParts());
            createViewGrids('left-view', getLeftBodyParts());
            createViewGrids('right-view', getRightBodyParts());
        }

        function createViewGrids(viewId, bodyParts) {
            const view = document.getElementById(viewId);
            bodyParts.forEach(part => {
                if (part.type === 'ellipse') {
                    createEllipseGrid(view, part);
                } else {
                    createRectGrid(view, part);
                }
            });
        }

        function getFrontBodyParts() {
            return [
                // Head (ellipse)
                { name: 'head', type: 'ellipse', cx: 200, cy: 80, rx: 50, ry: 60, grid: 10 },
                // Neck
                { name: 'neck', type: 'rect', x: 180, y: 130, width: 40, height: 30, grid: 4 },
                
                // Upper body - shoulders
                { name: 'left-shoulder', type: 'rect', x: 100, y: 160, width: 50, height: 40, grid: 5 },
                { name: 'right-shoulder', type: 'rect', x: 250, y: 160, width: 50, height: 40, grid: 5 },
                
                // Left arm - continuous connection
                { name: 'left-upper-arm', type: 'rect', x: 100, y: 200, width: 40, height: 60, grid: 6 },
                { name: 'left-elbow', type: 'rect', x: 100, y: 260, width: 40, height: 20, grid: 4 },
                { name: 'left-forearm', type: 'rect', x: 100, y: 280, width: 40, height: 60, grid: 6 },
                { name: 'left-wrist', type: 'rect', x: 100, y: 340, width: 40, height: 20, grid: 4 },
                { name: 'left-hand', type: 'rect', x: 95, y: 360, width: 50, height: 40, grid: 5 },
                
                // Right arm - continuous connection
                { name: 'right-upper-arm', type: 'rect', x: 260, y: 200, width: 40, height: 60, grid: 6 },
                { name: 'right-elbow', type: 'rect', x: 260, y: 260, width: 40, height: 20, grid: 4 },
                { name: 'right-forearm', type: 'rect', x: 260, y: 280, width: 40, height: 60, grid: 6 },
                { name: 'right-wrist', type: 'rect', x: 260, y: 340, width: 40, height: 20, grid: 4 },
                { name: 'right-hand', type: 'rect', x: 255, y: 360, width: 50, height: 40, grid: 5 },
                
                // Torso - detailed
                { name: 'chest-upper', type: 'rect', x: 150, y: 160, width: 100, height: 50, grid: 10 },
                { name: 'chest-lower', type: 'rect', x: 150, y: 210, width: 100, height: 50, grid: 10 },
                { name: 'abdomen-upper', type: 'rect', x: 150, y: 260, width: 100, height: 40, grid: 8 },
                { name: 'abdomen-lower', type: 'rect', x: 150, y: 300, width: 100, height: 40, grid: 8 },
                { name: 'pelvis', type: 'rect', x: 150, y: 340, width: 100, height: 40, grid: 8 },
                
                // Legs - detailed
                { name: 'left-hip', type: 'rect', x: 150, y: 380, width: 45, height: 20, grid: 4 },
                { name: 'left-thigh-upper', type: 'rect', x: 150, y: 400, width: 45, height: 40, grid: 8 },
                { name: 'left-thigh-lower', type: 'rect', x: 150, y: 440, width: 45, height: 40, grid: 8 },
                { name: 'left-knee', type: 'rect', x: 152, y: 480, width: 40, height: 20, grid: 4 },
                { name: 'left-shin-upper', type: 'rect', x: 152, y: 500, width: 40, height: 40, grid: 8 },
                { name: 'left-shin-lower', type: 'rect', x: 152, y: 540, width: 40, height: 30, grid: 6 },
                { name: 'left-ankle', type: 'rect', x: 152, y: 570, width: 40, height: 15, grid: 3 },
                { name: 'left-foot', type: 'rect', x: 145, y: 585, width: 50, height: 15, grid: 5 },
                
                { name: 'right-hip', type: 'rect', x: 205, y: 380, width: 45, height: 20, grid: 4 },
                { name: 'right-thigh-upper', type: 'rect', x: 205, y: 400, width: 45, height: 40, grid: 8 },
                { name: 'right-thigh-lower', type: 'rect', x: 205, y: 440, width: 45, height: 40, grid: 8 },
                { name: 'right-knee', type: 'rect', x: 208, y: 480, width: 40, height: 20, grid: 4 },
                { name: 'right-shin-upper', type: 'rect', x: 208, y: 500, width: 40, height: 40, grid: 8 },
                { name: 'right-shin-lower', type: 'rect', x: 208, y: 540, width: 40, height: 30, grid: 6 },
                { name: 'right-ankle', type: 'rect', x: 208, y: 570, width: 40, height: 15, grid: 3 },
                { name: 'right-foot', type: 'rect', x: 205, y: 585, width: 50, height: 15, grid: 5 }
            ];
        }

        function getBackBodyParts() {
            return [
                // Head (ellipse) 
                { name: 'head-back', type: 'ellipse', cx: 200, cy: 80, rx: 50, ry: 60, grid: 10 },
                // Neck
                { name: 'neck-back', type: 'rect', x: 180, y: 130, width: 40, height: 30, grid: 4 },
                
                // Upper body - shoulders
                { name: 'left-shoulder-back', type: 'rect', x: 100, y: 160, width: 50, height: 40, grid: 5 },
                { name: 'right-shoulder-back', type: 'rect', x: 250, y: 160, width: 50, height: 40, grid: 5 },
                
                // Back - detailed
                { name: 'upper-back', type: 'rect', x: 150, y: 160, width: 100, height: 100, grid: 10 },
                { name: 'lower-back', type: 'rect', x: 150, y: 260, width: 100, height: 80, grid: 10 },
                { name: 'buttocks', type: 'rect', x: 150, y: 340, width: 100, height: 40, grid: 8 },
                
                // Arms - back view
                { name: 'left-arm-back', type: 'rect', x: 100, y: 200, width: 40, height: 200, grid: 10 },
                { name: 'right-arm-back', type: 'rect', x: 260, y: 200, width: 40, height: 200, grid: 10 },
                
                // Legs - back view
                { name: 'left-thigh-back', type: 'rect', x: 150, y: 380, width: 45, height: 100, grid: 10 },
                { name: 'right-thigh-back', type: 'rect', x: 205, y: 380, width: 45, height: 100, grid: 10 },
                { name: 'left-calf-back', type: 'rect', x: 152, y: 480, width: 40, height: 100, grid: 10 },
                { name: 'right-calf-back', type: 'rect', x: 208, y: 480, width: 40, height: 100, grid: 10 },
                { name: 'left-foot-back', type: 'rect', x: 145, y: 580, width: 50, height: 20, grid: 5 },
                { name: 'right-foot-back', type: 'rect', x: 205, y: 580, width: 50, height: 20, grid: 5 }
            ];
        }

        function getLeftBodyParts() {
            return [
                // Head (ellipse)
                { name: 'head-left', type: 'ellipse', cx: 200, cy: 80, rx: 40, ry: 60, grid: 8 },
                // Neck
                { name: 'neck-left', type: 'rect', x: 185, y: 130, width: 30, height: 30, grid: 3 },
                // Shoulder to arm
                { name: 'shoulder-left', type: 'rect', x: 170, y: 160, width: 45, height: 40, grid: 4 },
                { name: 'arm-upper-left', type: 'rect', x: 130, y: 200, width: 35, height: 80, grid: 6 },
                { name: 'arm-lower-left', type: 'rect', x: 130, y: 280, width: 35, height: 80, grid: 6 },
                // Torso
                { name: 'torso-upper-left', type: 'rect', x: 170, y: 160, width: 60, height: 90, grid: 8 },
                { name: 'torso-lower-left', type: 'rect', x: 170, y: 250, width: 60, height: 90, grid: 8 },
                { name: 'hip-left', type: 'rect', x: 170, y: 340, width: 60, height: 40, grid: 6 },
                // Legs
                { name: 'thigh-left', type: 'rect', x: 175, y: 380, width: 50, height: 100, grid: 10 },
                { name: 'shin-left', type: 'rect', x: 177, y: 480, width: 45, height: 100, grid: 10 },
                { name: 'foot-left', type: 'rect', x: 170, y: 580, width: 55, height: 20, grid: 5 }
            ];
        }

        function getRightBodyParts() {
            return [
                // Head (ellipse)
                { name: 'head-right', type: 'ellipse', cx: 200, cy: 80, rx: 40, ry: 60, grid: 8 },
                // Neck
                { name: 'neck-right', type: 'rect', x: 185, y: 130, width: 30, height: 30, grid: 3 },
                // Shoulder to arm
                { name: 'shoulder-right', type: 'rect', x: 185, y: 160, width: 45, height: 40, grid: 4 },
                { name: 'arm-upper-right', type: 'rect', x: 235, y: 200, width: 35, height: 80, grid: 6 },
                { name: 'arm-lower-right', type: 'rect', x: 235, y: 280, width: 35, height: 80, grid: 6 },
                // Torso
                { name: 'torso-upper-right', type: 'rect', x: 170, y: 160, width: 60, height: 90, grid: 8 },
                { name: 'torso-lower-right', type: 'rect', x: 170, y: 250, width: 60, height: 90, grid: 8 },
                { name: 'hip-right', type: 'rect', x: 170, y: 340, width: 60, height: 40, grid: 6 },
                // Legs
                { name: 'thigh-right', type: 'rect', x: 175, y: 380, width: 50, height: 100, grid: 10 },
                { name: 'shin-right', type: 'rect', x: 177, y: 480, width: 45, height: 100, grid: 10 },
                { name: 'foot-right', type: 'rect', x: 175, y: 580, width: 55, height: 20, grid: 5 }
            ];
        }

        function createEllipseGrid(container, part) {
            // Ê≠£ÊñπÂΩ¢„Çª„É´„ÅÆ„Çµ„Ç§„Ç∫„ÇíÂõ∫ÂÆöÔºà5„Éî„ÇØ„Çª„É´Ôºâ
            const cellSize = 5;
            
            // Ê•ïÂÜÜ„Çí„Ç´„Éê„Éº„Åô„Çã„Ç∞„É™„ÉÉ„Éâ„ÅÆÁØÑÂõ≤„ÇíË®àÁÆó
            const startX = part.cx - part.rx;
            const endX = part.cx + part.rx;
            const startY = part.cy - part.ry;
            const endY = part.cy + part.ry;
            
            const colCount = Math.floor((endX - startX) / cellSize);
            const rowCount = Math.floor((endY - startY) / cellSize);
            
            for (let row = 0; row < rowCount; row++) {
                for (let col = 0; col < colCount; col++) {
                    const x = startX + col * cellSize + cellSize/2;
                    const y = startY + row * cellSize + cellSize/2;
                    
                    const normalizedX = (x - part.cx) / part.rx;
                    const normalizedY = (y - part.cy) / part.ry;
                    
                    // Ê•ïÂÜÜÂÜÖ„Å´„ÅÇ„Çã„Çª„É´„ÅÆ„Åø‰ΩúÊàê
                    if (normalizedX * normalizedX + normalizedY * normalizedY <= 1) {
                        createGridCell(container, part.name, row, col, x - cellSize/2, y - cellSize/2, cellSize, cellSize);
                    }
                }
            }
        }

        function createRectGrid(container, part) {
            const gridSize = part.grid;
            // Ê≠£ÊñπÂΩ¢„Çª„É´„ÅÆ„Çµ„Ç§„Ç∫„ÇíÂõ∫ÂÆöÔºà5„Éî„ÇØ„Çª„É´Ôºâ
            const cellSize = 5;
            
            // ÂÆüÈöõ„ÅÆ„Ç∞„É™„ÉÉ„ÉâÊï∞„ÇíË®àÁÆó
            const colCount = Math.floor(part.width / cellSize);
            const rowCount = Math.floor(part.height / cellSize);
            
            for (let row = 0; row < rowCount; row++) {
                for (let col = 0; col < colCount; col++) {
                    const x = part.x + col * cellSize;
                    const y = part.y + row * cellSize;
                    createGridCell(container, part.name, row, col, x, y, cellSize, cellSize);
                }
            }
        }

        function createGridCell(container, partName, row, col, x, y, width, height) {
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('class', 'head-cell');
            rect.setAttribute('data-part', `${partName}-${row}-${col}`);
            rect.setAttribute('x', x);
            rect.setAttribute('y', y);
            rect.setAttribute('width', width);
            rect.setAttribute('height', height);
            rect.setAttribute('rx', '1');
            container.appendChild(rect);
            
            rect.addEventListener('click', function(e) {
                // Always use toggle behavior for individual clicks
                const partName = this.dataset.part;
                
                if (e.ctrlKey || e.metaKey) {
                    // Ctrl+„ÇØ„É™„ÉÉ„ÇØ„ÅßËøΩÂä†/Ëß£Èô§
                    if (selectedParts.has(partName)) {
                        selectedParts.delete(partName);
                        this.classList.remove('selected');
                    } else {
                        selectedParts.add(partName);
                        this.classList.add('selected');
                    }
                } else {
                    // ÈÄöÂ∏∏„ÇØ„É™„ÉÉ„ÇØ„ÅßÂçò‰∏ÄÈÅ∏Êäû
                    if (selectedParts.has(partName) && selectedParts.size === 1) {
                        // Êó¢„Å´ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØËß£Èô§
                        selectedParts.clear();
                        document.querySelectorAll('.head-cell.selected, .body-part.selected').forEach(el => {
                            el.classList.remove('selected');
                        });
                    } else {
                        // Êñ∞„Åó„ÅèÈÅ∏Êäû
                        selectedParts.clear();
                        document.querySelectorAll('.head-cell.selected, .body-part.selected').forEach(el => {
                            el.classList.remove('selected');
                        });
                        selectedParts.add(partName);
                        this.classList.add('selected');
                    }
                }
                
                // Update UI
                if (selectedParts.size === 1) {
                    const singlePart = Array.from(selectedParts)[0];
                    const existingPain = painData[singlePart] || 0;
                    updatePainButtonSelection(Math.round(existingPain));
                } else if (selectedParts.size > 1) {
                    let totalPain = 0;
                    selectedParts.forEach(part => {
                        totalPain += painData[part] || 0;
                    });
                    const avgPain = totalPain / selectedParts.size;
                    updatePainButtonSelection(Math.round(avgPain));
                } else {
                    updatePainButtonSelection(0);
                    document.getElementById('bodyPartSelect').value = '';
                }
                
                e.stopPropagation();
            });
        }

        // View tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentView = this.dataset.view;
                switchView(currentView);
            });
        });

        function switchView(view) {
            // Hide all views
            document.getElementById('front-view').style.display = 'none';
            document.getElementById('back-view').style.display = 'none';
            document.getElementById('left-view').style.display = 'none';
            document.getElementById('right-view').style.display = 'none';
            
            // Show selected view
            if (view === 'front') {
                document.getElementById('front-view').style.display = 'block';
            } else if (view === 'back') {
                document.getElementById('back-view').style.display = 'block';
            } else if (view === 'left') {
                document.getElementById('left-view').style.display = 'block';
            } else if (view === 'right') {
                document.getElementById('right-view').style.display = 'block';
            }
        }

        // Body part selection is now handled by grid cells

        function selectBodyPart(partName, addToSelection = false) {
            const part = document.querySelector(`[data-part="${partName}"]`);
            if (!part) return;
            
            // Check if we should add to selection
            const shouldAddToSelection = addToSelection;
            
            if (!shouldAddToSelection) {
                // Single selection - clear previous selections
                selectedParts.clear();
                document.querySelectorAll('.body-part, .head-cell').forEach(p => p.classList.remove('selected'));
            }
            
            if (selectedParts.has(partName)) {
                // Deselect if already selected (toggle behavior)
                selectedParts.delete(partName);
                part.classList.remove('selected');
            } else {
                // Add to selection
                selectedParts.add(partName);
                part.classList.add('selected');
            }
            
            // Update UI based on selection
            if (selectedParts.size === 1) {
                const singlePart = Array.from(selectedParts)[0];
                if (!singlePart.startsWith('head-')) {
                    document.getElementById('bodyPartSelect').value = singlePart;
                } else {
                    document.getElementById('bodyPartSelect').value = '';
                }
                const existingPain = painData[singlePart] || 0;
                updatePainButtonSelection(Math.round(existingPain));
            } else if (selectedParts.size > 1) {
                document.getElementById('bodyPartSelect').value = '';
                // Calculate average pain level for multiple parts
                let totalPain = 0;
                selectedParts.forEach(part => {
                    totalPain += painData[part] || 0;
                });
                const avgPain = totalPain / selectedParts.size;
                updatePainButtonSelection(Math.round(avgPain));
            } else {
                // No selection
                document.getElementById('bodyPartSelect').value = '';
                updatePainButtonSelection(0);
            }
        }

        // Pain level button selection
        let currentPainLevel = 0;
        
        function updatePainButtonSelection(level) {
            currentPainLevel = level;
            document.querySelectorAll('.pain-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            const selectedBtn = document.querySelector(`.pain-btn[data-level="${level}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
            document.getElementById('painValue').textContent = `ÈÅ∏Êäû: ${level}`;
        }

        // Pain button event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.pain-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const level = parseInt(this.dataset.level);
                    updatePainButtonSelection(level);
                    
                    // Apply to all selected parts
                    selectedParts.forEach(partName => {
                        painData[partName] = level;
                        const part = document.querySelector(`[data-part="${partName}"]`);
                        if (part) {
                            updatePartColor(part, level);
                        }
                    });
                });
            });
        });

        // Body part select dropdown
        document.getElementById('bodyPartSelect').addEventListener('change', function() {
            if (this.value) {
                selectBodyPart(this.value);
            }
        });

        function updatePartColor(element, painLevel) {
            let color;
            if (painLevel === 0) {
                color = '#f0f0f0';
            } else {
                // Ëµ§Ëâ≤„ÅÆÂçò‰∏Ä„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ÔºàÈÄèÊòéÂ∫¶„Å®Âº∑Â∫¶„ÅßË™øÊï¥Ôºâ
                const intensity = painLevel / 10;
                const red = Math.floor(255 - (100 * (1 - intensity)));
                const alpha = 0.2 + (intensity * 0.8);
                color = `rgba(${red}, 0, 0, ${alpha})`;
            }
            element.style.fill = color;
        }

        // Save button
        document.getElementById('saveBtn').addEventListener('click', function() {
            if (!currentPerson) {
                showNotification('ÂÖà„Å´‰∫∫Áâ©„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (!currentDate) {
                currentDate = document.getElementById('dateInput').value || new Date().toISOString().split('T')[0];
            }
            
            if (!personsData[currentPerson].dates) {
                personsData[currentPerson].dates = {};
            }
            
            personsData[currentPerson].dates[currentDate] = {...painData};
            savePersonsData();
            updateDateHistory();
            
            console.log(`Saved data for ${currentPerson} on ${currentDate}:`, painData);
            showNotification(`${currentPerson}„ÅÆ${currentDate}„ÅÆ„Éá„Éº„Çø„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅÔºà${Object.keys(painData).length}ÈÉ®‰ΩçÔºâ`);
        });

        // Clear button
        document.getElementById('clearBtn').addEventListener('click', function() {
            if (confirm('„Åô„Åπ„Å¶„ÅÆÁóõ„Åø„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
                painData = {};
                document.querySelectorAll('.body-part, .head-cell').forEach(part => {
                    part.style.fill = '#f0f0f0';
                    part.classList.remove('selected');
                });
                updatePainButtonSelection(0);
                document.getElementById('bodyPartSelect').value = '';
                selectedParts.clear();
                console.log('Data cleared:', painData);
            }
        });


        function initializeEventListeners() {
            // Initialize all parts with default color
            document.querySelectorAll('.body-part, .head-cell').forEach(part => {
                part.style.fill = '#f0f0f0';
            });
        }

        // Initialize date controls
        function initializeDateControls() {
            const dateInput = document.getElementById('dateInput');
            const todayBtn = document.getElementById('todayBtn');
            const dateHistorySelect = document.getElementById('dateHistorySelect');
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            currentDate = today;
            
            // Today button
            todayBtn.addEventListener('click', function() {
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
                currentDate = today;
                if (currentPerson) {
                    loadDateData(today);
                    showNotification('‰ªäÊó•„ÅÆÊó•‰ªò„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü');
                }
            });
            
            // Date input change
            dateInput.addEventListener('change', function() {
                currentDate = this.value;
                if (currentPerson) {
                    loadDateData(currentDate);
                    showNotification(`${currentDate}„ÅÆ„Éá„Éº„Çø„ÇíË°®Á§∫`);
                }
            });
            
            // Date history select
            dateHistorySelect.addEventListener('change', function() {
                if (this.value) {
                    dateInput.value = this.value;
                    currentDate = this.value;
                    loadDateData(currentDate);
                    showNotification(`${currentDate}„ÅÆË®òÈå≤„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);
                }
            });
        }
    </script>
    <script src="touch-drag-box-v2.js"></script>
</body>
</html>